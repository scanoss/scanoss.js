import { HttpClient } from "../http/HttpClient";
import { Component } from "../../shared/interfaces/Component";
import { IVulnerabilityClient } from "./IVulnerabilityClient";
import { logger } from "../../Logger";

export class VulnerabilityHttpClient extends HttpClient implements IVulnerabilityClient{
  private client: HttpClient;
  private readonly baseUrl: string;

  constructor(token: string, hostName: string, proxyHost?: string, caCertPath?: string) {
    super();
    this.client = new HttpClient({
      HOST_URL: hostName,
      API_KEY: token,
      HTTPS_PROXY: proxyHost,
      CA_CERT: caCertPath,
    });
    this.baseUrl = hostName;
  }

  public async getVulnerabilitiesComponents(components: Array<Component>): Promise<any> {
    try{
      const response = await this.client.post(`${this.baseUrl}/api/v2/vulnerabilities/components`, components);
      if (response.ok) {
        const vulnerabilities = await response.json();
        return vulnerabilities;
      }
      const errorText = await response.text();
      const errorMessage = `Failed to get vulnerabilities: ${response.status} ${response.statusText} - ${errorText}`;
      logger.log(`Error getting vulnerabilities: ${errorMessage}`);
      throw new Error(errorMessage);
    } catch (error) {
      logger.log('Error getting vulnerabilities:', error);
      throw this.handleError(error, 'Failed to get vulnerabilities');
    }
  }

  public async getVulnerabilitiesComponent(component: Component): Promise<any> {
    try {
      const queryParams = new URLSearchParams();
      queryParams.append('purl', component.purl);
      if (component.requirement) {
        queryParams.append('requirement', component.requirement);
      }
      const response =  await this.client.get(`${this.baseUrl}/api/v2/vulnerabilities/component?${queryParams.toString()}`);
      if (response.ok) {
        const vulnerabilities = await response.json();
        return vulnerabilities;
      }
      const errorText = await response.text();
      const errorMessage = `Failed to get vulnerabilities: ${response.status} ${response.statusText} - ${errorText}`;
      logger.log(`Error getting vulnerabilities: ${errorMessage}`);
      throw new Error(errorMessage);
    } catch (error) {
      logger.log('Error getting vulnerabilities:', error);
      throw this.handleError(error, 'Failed to get vulnerabilities');
    }
  }
}
